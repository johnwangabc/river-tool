# 巡河宝统计工具 使用指南

河流巡护活动数据统计与导出工具

## 本地运行与构建

- 本地调试：运行 `npm start` 或 `npm run android/ios/web`，无需登录 Expo/EAS。
- 避免 EAS 登录提示：使用 Expo Access Token 并通过包装脚本执行命令。
  1. 在 Expo 账户设置中生成访问令牌。
  2. 在项目根目录创建 `.env.local`，添加 `EXPO_TOKEN=你的token`（已被 `.gitignore` 忽略）。
  3. 通过包装脚本运行，如 `npm run eas -- build --platform ios --profile production`，脚本会自动加上 `--non-interactive`，没有 token 会直接报错，不会出现登录提示。
  4. 若要手动输入账号密码或处理交互提示，在命令前加 `ALLOW_INTERACTIVE=1`，如 `ALLOW_INTERACTIVE=1 npm run eas -- build --platform android --profile apk`。

## 打包 APK

1. 确保已安装依赖：`npm install`。
2. 选择登录方式：
   - 无交互：在 `.env.local` 中填写 `EXPO_TOKEN=...`。
   - 交互式：命令前加 `ALLOW_INTERACTIVE=1`，会在缺少 token 且未登录时提示你输入账号密码。
3. 运行 `npm run eas -- build --platform android --profile apk`（如需交互，前置 `ALLOW_INTERACTIVE=1`）。
   - `eas.json` 已预设 `apk` 配置，会生成可直接安装的 APK。
   - 首次构建需在 Expo/EAS 控制台或 CLI 里配置 Android keystore（非交互模式请先在控制台上传 keystore）。
4. 构建完成后，命令行会给出下载链接，下载即可获取 APK。

## 首次使用配置

### 获取认证令牌
1. 使用抓包工具抓包巡河宝
2. 在请求头中找到 `Authorization`，复制完整内容
   - 格式如：`Bearer eyJ0eXAiOiJKV1QiLCJhbGc...`

### 配置应用
1. 打开应用，点击底部"设置"
2. 将复制的令牌粘贴到"认证令牌"输入框
3. 组织ID保持默认值 843（如需修改请输入正确的ID）
4. 点击"保存设置"

## 功能使用

### 📊 活动统计
统计指定日期及之后的所有活动数据

**使用步骤：**
1. 点击底部"活动统计"标签
2. 输入目标日期（如：2025-01-01）
3. 点击"开始统计"按钮
4. 等待数据加载完成（会显示进度提示）
5. 查看统计摘要：活动总数、巡河数、净滩数、参与人数等
6. 查看详细活动列表
7. 点击"导出Excel"保存数据到手机

**导出内容：**
- 参与者明细表（姓名、活动次数、活动名称等）
- 统计摘要数据

---

### 🌊 巡护评测
统计指定用户的巡河和环境评测次数

**使用步骤：**
1. 点击底部"巡护评测"标签
2. 输入用户ID（多个ID用逗号分隔，如：123,456,789）
3. 输入开始日期和结束日期
4. 点击"开始统计"按钮
5. 查看每个用户的巡河次数和评测次数
6. 点击"导出Excel"保存数据

**导出内容：**
- 用户巡河次数统计
- 用户评测次数统计

---

### 📈 综合统计
多维度统计用户参与活动的情况

**使用步骤：**
1. 点击底部"综合统计"标签
2. 输入用户ID列表（逗号分隔）
3. 设置统计的日期范围
4. 点击"开始统计"按钮
5. 查看各类活动的参与次数统计
6. 点击"导出Excel"保存综合报表

**导出内容：**
- 用户活动参与次数明细

---

## 常见问题

**Q: 提示"获取数据失败"怎么办？**
- 检查网络连接是否正常
- 确认认证令牌是否过期（重新获取并配置）
- 确认组织ID是否正确

**Q: 导出的Excel文件在哪里？**
- Android：下载文件夹或系统会提示保存位置
- 导出后会弹出分享菜单，可选择保存位置或分享

**Q: 令牌多久过期？**
- 根据系统设置，通常几小时到几天不等
- 过期后重新按照首次配置步骤获取新令牌

**Q: 日期格式是什么？**
- 统一使用格式：yyyy-MM-dd
- 例如：2025-11-02

**Q: 用户ID在哪里查看？**
- 在巡河宝系统的用户管理页面
- 或从数据导出中获取

---

## 注意事项

- 首次使用必须先配置认证令牌
- 确保手机网络连接正常
- 统计大量数据时请耐心等待
- 定期检查令牌是否过期
- 导出的Excel文件可用WPS、Excel等软件打开
