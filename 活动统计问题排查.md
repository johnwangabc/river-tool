# 活动统计问题快速排查

## 现在请按以下步骤操作

### 1. 重新加载应用
```
在Expo Go中：
- 摇晃手机
- 点击 "Reload"

或在电脑上：
- 在Metro Bundler终端按 r 键
```

### 2. 打开开发者菜单查看日志

**Android**:
- 摇晃手机 → Show Dev Menu → Remote JS Debugging
- 或者查看电脑终端的日志

**iOS**:
- 摇晃手机 → Debug Remote JS
- 浏览器会打开，按F12查看Console

### 3. 重新测试活动统计

1. 进入"活动统计"页面
2. 输入一个日期（建议使用一个月前的日期）
3. 点击"开始统计"
4. **重要**: 仔细查看终端或控制台的输出

### 4. 需要收集的信息

**请告诉我以下信息**：

#### A. 成功提示信息
```
Alert显示: "已获取 X 个活动的详细数据
活动信息: Y 条"
```
X = ?
Y = ?

#### B. 控制台日志
```
=== 数据处理结果 ===
detailsData长度: ?
basicInfo长度: ?
basicInfo示例: ?
统计数据: ?
```

#### C. 界面显示情况
- [ ] 统计摘要卡片是否显示？
- [ ] 如果显示，显示了哪些数字？
- [ ] 活动数据表格是否显示？
- [ ] "导出Excel"按钮是否出现？

#### D. 点击导出Excel后
- 是否弹出错误？
- 错误信息是什么？
- 控制台显示什么？

## 常见情况分析

### 情况1: Alert显示 "活动信息: 0 条"

**问题**: 数据提取失败

**原因可能是**:
- API返回的数据格式与预期不符
- `code` 字段不是 200
- `data` 字段结构改变

**需要查看**:
```javascript
console.log('detailsData示例:', detailsData[0]);
```

### 情况2: Alert显示正确，但界面不显示

**问题**: 状态更新或渲染问题

**已添加修复**:
- 调整了状态更新顺序
- 添加了延迟显示
- 确保数据先设置

### 情况3: 显示正常，但导出失败

**问题**: Excel生成或分享问题

**可能原因**:
- 权限问题
- expo-file-system 或 expo-sharing 未正确安装
- xlsx 库问题

**检查**:
```bash
npm list expo-file-system
npm list expo-sharing
npm list xlsx
```

## 最可能的问题

根据您的描述"已经获取3个活动的详细数据"，最可能的问题是：

### 问题: 数据获取成功，但 displayData 状态未正确设置

**已添加的修复**:

```javascript
// 1. 先设置数据
setDisplayData(basicInfo);
setStats(activityStats);

// 2. 延迟显示，确保React状态已更新
setTimeout(() => {
  setShowData(true);
}, 100);
```

### 问题: basicInfo 可能是空数组

**原因**: `extractActivityBasicInfo` 可能过滤掉了所有数据

**检查方法**:
```javascript
console.log('basicInfo长度:', basicInfo.length);
console.log('basicInfo内容:', basicInfo);
```

## 如果上述都不行

### 临时测试方法

在 handleAnalyze 函数中，手动设置测试数据：

```javascript
// 在 setDisplayData(basicInfo); 之前添加
const testData = [
  {
    活动ID: 1,
    活动名称: '测试活动1',
    发起人: '张三',
    开始时间: '2025-01-01 10:00:00',
    活动类型: '巡河',
    实际参与人数: 10,
    浏览量: 100
  }
];

setDisplayData(testData);
setStats({
  活动总数: 1,
  巡河活动数: 1,
  净滩活动数: 0,
  总参与人数: 10,
  平均参与人数: '10.00'
});
```

如果使用测试数据能显示和导出，说明问题在数据处理部分。

## 请告诉我

测试后请告诉我：

1. **控制台日志**中 basicInfo.length 是多少？
2. **统计摘要**是否显示？如果显示，显示什么内容？
3. **表格**是否显示？
4. **导出Excel**时的具体错误信息是什么？

有了这些信息，我可以精确定位问题并提供解决方案。

---

**重要提示**: 现在就重新加载应用并测试，然后告诉我上述4个问题的答案。
